@page "/user-migration"
@using B2C_user_management.Models
@using B2C_user_management.Services
@using ClosedXML.Excel
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@inject IUserMigrationService MigrationService
@inject IJSRuntime JS
@inject ILogger<UserMigration> Logger
@rendermode InteractiveServer

<PageTitle>B2C User Migration</PageTitle>

<div class="container mt-4">
    <h1 class="mb-4">
        <i class="bi bi-person-plus-fill me-2"></i>
        Azure AD B2C User Migration
    </h1>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="bi bi-upload me-2"></i>
                Upload Users for Migration
            </h5>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <h6><i class="bi bi-info-circle me-2"></i>Instructions:</h6>
                <ul class="mb-0">
                    <li>Upload an Excel file (.xlsx or .xls) containing user data for migration</li>
                    <li>Required columns: <strong>Email</strong>, <strong>Password</strong></li>
                    <li>Optional columns: <strong>FirstName</strong>, <strong>LastName</strong>, <strong>DisplayName</strong></li>
                    <li>If DisplayName is empty, it will be auto-generated from FirstName and LastName</li>
                </ul>
            </div>

            <div class="row mb-3">
                <div class="col-md-8">
                    <InputFile OnChange="HandleFileSelected" class="form-control" accept=".xlsx,.xls" />
                </div>
                <div class="col-md-4">
                    <button class="btn btn-outline-secondary w-100" @onclick="DownloadTemplate">
                        <i class="bi bi-download me-2"></i>Download Template
                    </button>
                </div>
            </div>

            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" @bind="forceChangePassword" id="forceChangePassword">
                <label class="form-check-label" for="forceChangePassword">
                    <strong>Force password change on next sign-in</strong>
                    <small class="text-muted d-block">When enabled, users will be required to change their password upon first login</small>
                </label>
            </div>

            @if (!string.IsNullOrEmpty(fileName))
            {
                <div class="alert alert-success">
                    <i class="bi bi-check-circle me-2"></i>
                    File loaded: <strong>@fileName</strong> - @usersToMigrate.Count user(s) found
                </div>

                <button class="btn btn-primary btn-lg" @onclick="MigrateUsers" disabled="@isProcessing">
                    @if (isProcessing)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        <span>Migrating Users...</span>
                    }
                    else
                    {
                        <i class="bi bi-cloud-upload me-2"></i>
                        <span>Start Migration</span>
                    }
                </button>
            }
        </div>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
        </div>
    }

    @if (usersToMigrate.Count > 0)
    {
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>
                    Users to Migrate (@usersToMigrate.Count)
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>#</th>
                                <th>Email</th>
                                <th>First Name</th>
                                <th>Last Name</th>
                                <th>Display Name</th>
                                <th>Password</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int rowNum = 0;
                            }
                            @foreach (var user in usersToMigrate)
                            {
                                rowNum++;
                                <tr>
                                    <td>@rowNum</td>
                                    <td>@user.Email</td>
                                    <td>@user.FirstName</td>
                                    <td>@user.LastName</td>
                                    <td>@user.DisplayName</td>
                                    <td><span class="text-muted">********</span></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    @if (migrationResults.Count > 0)
    {
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-clipboard-check me-2"></i>
                    Migration Results
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h3>@migrationResults.Count(r => r.Success && !r.Revoked)</h3>
                                <p class="mb-0">Active</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-dark">
                            <div class="card-body text-center">
                                <h3>@migrationResults.Count(r => r.Revoked)</h3>
                                <p class="mb-0">Revoked</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body text-center">
                                <h3>@migrationResults.Count(r => !r.Success && !r.Revoked)</h3>
                                <p class="mb-0">Failed</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h3>@migrationResults.Count</h3>
                                <p class="mb-0">Total</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="btn-group mb-3">
                    <button class="btn btn-success" @onclick="DownloadResultsCsv">
                        <i class="bi bi-filetype-csv me-2"></i>Download CSV
                    </button>
                    <button class="btn btn-success" @onclick="DownloadResultsExcel">
                        <i class="bi bi-file-earmark-excel me-2"></i>Download Excel
                    </button>
                </div>

                @if (migrationResults.Any(r => r.Success && !r.Revoked && !string.IsNullOrEmpty(r.B2CObjectId)))
                {
                    <div class="alert alert-warning mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>@migrationResults.Count(r => r.Success && !r.Revoked && !string.IsNullOrEmpty(r.B2CObjectId))</strong> user(s) can be revoked (deleted from B2C)
                            </div>
                            <button class="btn btn-danger" @onclick="RevokeMigration" disabled="@isRevoking">
                                @if (isRevoking)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    <span>Revoking...</span>
                                }
                                else
                                {
                                    <i class="bi bi-trash me-2"></i>
                                    <span>Revoke Migration</span>
                                }
                            </button>
                        </div>
                    </div>
                }

                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>#</th>
                                <th>Email</th>
                                <th>Display Name</th>
                                <th>Status</th>
                                <th>B2C Object ID</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int resultNum = 0;
                            }
                            @foreach (var result in migrationResults)
                            {
                                resultNum++;
                                <tr class="@(result.Revoked ? "table-warning" : (result.Success ? "table-success" : "table-danger"))">
                                    <td>@resultNum</td>
                                    <td>@result.Email</td>
                                    <td>@result.DisplayName</td>
                                    <td>
                                        @if (result.Revoked)
                                        {
                                            <span class="badge bg-warning text-dark">
                                                <i class="bi bi-trash me-1"></i>Revoked
                                            </span>
                                        }
                                        else if (result.Success)
                                        {
                                            <span class="badge bg-success">
                                                <i class="bi bi-check-circle me-1"></i>Active
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">
                                                <i class="bi bi-x-circle me-1"></i>Failed
                                            </span>
                                        }
                                    </td>
                                    <td><code>@result.B2CObjectId</code></td>
                                    <td>@result.ErrorMessage</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<UserMigrationRecord> usersToMigrate = new();
    private List<UserMigrationResult> migrationResults = new();
    private List<RevokeUserResult> revokeResults = new();
    private string fileName = string.Empty;
    private string errorMessage = string.Empty;
    private bool isProcessing = false;
    private bool isRevoking = false;
    private bool forceChangePassword = true;

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        try
        {
            errorMessage = string.Empty;
            usersToMigrate.Clear();
            migrationResults.Clear();

            var file = e.File;
            if (file == null)
            {
                return;
            }

            fileName = file.Name;

            using var stream = new MemoryStream();
            await file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).CopyToAsync(stream);
            stream.Position = 0;

            using var workbook = new XLWorkbook(stream);
            var worksheet = workbook.Worksheets.First();

            var headerRow = worksheet.Row(1);
            var headers = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase);

            for (int col = 1; col <= headerRow.LastCellUsed()?.Address.ColumnNumber; col++)
            {
                var headerValue = headerRow.Cell(col).GetString().Trim();
                if (!string.IsNullOrEmpty(headerValue))
                {
                    headers[headerValue] = col;
                }
            }

            if (!headers.ContainsKey("Email"))
            {
                errorMessage = "Excel file must contain an 'Email' column.";
                fileName = string.Empty;
                return;
            }

            if (!headers.ContainsKey("Password"))
            {
                errorMessage = "Excel file must contain a 'Password' column.";
                fileName = string.Empty;
                return;
            }

            var lastRow = worksheet.LastRowUsed()?.RowNumber() ?? 1;

            for (int row = 2; row <= lastRow; row++)
            {
                var email = worksheet.Cell(row, headers["Email"]).GetString().Trim();

                if (string.IsNullOrEmpty(email))
                {
                    continue;
                }

                var password = headers.ContainsKey("Password")
                    ? worksheet.Cell(row, headers["Password"]).GetString().Trim()
                    : string.Empty;

                var firstName = headers.ContainsKey("FirstName")
                    ? worksheet.Cell(row, headers["FirstName"]).GetString().Trim()
                    : string.Empty;

                var lastName = headers.ContainsKey("LastName")
                    ? worksheet.Cell(row, headers["LastName"]).GetString().Trim()
                    : string.Empty;

                var displayName = headers.ContainsKey("DisplayName")
                    ? worksheet.Cell(row, headers["DisplayName"]).GetString().Trim()
                    : string.Empty;

                if (string.IsNullOrEmpty(displayName))
                {
                    displayName = $"{firstName} {lastName}".Trim();
                    if (string.IsNullOrEmpty(displayName))
                    {
                        displayName = email.Split('@')[0];
                    }
                }

                usersToMigrate.Add(new UserMigrationRecord
                {
                    Email = email,
                    FirstName = firstName,
                    LastName = lastName,
                    DisplayName = displayName,
                    Password = password
                });
            }

            if (usersToMigrate.Count == 0)
            {
                errorMessage = "No valid user records found in the Excel file.";
                fileName = string.Empty;
            }

            Logger.LogInformation("Loaded {Count} users from file {FileName}", usersToMigrate.Count, fileName);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error reading file: {ex.Message}";
            fileName = string.Empty;
            Logger.LogError(ex, "Error reading Excel file");
        }
    }

    private async Task MigrateUsers()
    {
        if (usersToMigrate.Count == 0)
        {
            return;
        }

        isProcessing = true;
        migrationResults.Clear();
        StateHasChanged();

        try
        {
            Logger.LogInformation("Starting migration of {Count} users", usersToMigrate.Count);

            var response = await MigrationService.MigrateUsersAsync(usersToMigrate, forceChangePassword);

            if (response != null && response.Results != null)
            {
                migrationResults = response.Results;
                Logger.LogInformation("Migration completed. Success: {Success}, Failed: {Failed}",
                    migrationResults.Count(r => r.Success),
                    migrationResults.Count(r => !r.Success));
            }
            else
            {
                errorMessage = "No response received from migration service.";
                Logger.LogWarning("Migration service returned null response");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Migration error: {ex.Message}";
            Logger.LogError(ex, "Error during user migration");
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task DownloadTemplate()
    {
        try
        {
            using var workbook = new XLWorkbook();
            var worksheet = workbook.Worksheets.Add("Users");

            worksheet.Cell(1, 1).Value = "Email";
            worksheet.Cell(1, 2).Value = "Password";
            worksheet.Cell(1, 3).Value = "FirstName";
            worksheet.Cell(1, 4).Value = "LastName";
            worksheet.Cell(1, 5).Value = "DisplayName";

            var headerRange = worksheet.Range(1, 1, 1, 5);
            headerRange.Style.Font.Bold = true;
            headerRange.Style.Fill.BackgroundColor = XLColor.LightBlue;

            worksheet.Cell(2, 1).Value = "user1@example.com";
            worksheet.Cell(2, 2).Value = "SecureP@ssw0rd1!";
            worksheet.Cell(2, 3).Value = "John";
            worksheet.Cell(2, 4).Value = "Doe";
            worksheet.Cell(2, 5).Value = "John Doe";

            worksheet.Cell(3, 1).Value = "user2@example.com";
            worksheet.Cell(3, 2).Value = "SecureP@ssw0rd2!";
            worksheet.Cell(3, 3).Value = "Jane";
            worksheet.Cell(3, 4).Value = "Smith";
            worksheet.Cell(3, 5).Value = "";

            worksheet.Columns().AdjustToContents();

            using var stream = new MemoryStream();
            workbook.SaveAs(stream);
            var content = stream.ToArray();
            var base64 = Convert.ToBase64String(content);

            await JS.InvokeVoidAsync("downloadFile", "UserMigrationTemplate.xlsx", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", base64);

            Logger.LogInformation("Template downloaded successfully");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error downloading template: {ex.Message}";
            Logger.LogError(ex, "Error downloading template");
        }
    }

    private async Task DownloadResultsCsv()
    {
        try
        {
            var csv = new System.Text.StringBuilder();
            csv.AppendLine("Email,FirstName,LastName,DisplayName,Status,B2CObjectId,ErrorMessage");

            foreach (var result in migrationResults)
            {
                var status = result.Revoked ? "Revoked" : (result.Success ? "Active" : "Failed");
                var escapedError = result.ErrorMessage?.Replace("\"", "\"\"") ?? "";
                csv.AppendLine($"\"{result.Email}\",\"{result.FirstName}\",\"{result.LastName}\",\"{result.DisplayName}\",\"{status}\",\"{result.B2CObjectId}\",\"{escapedError}\"");
            }

            var bytes = System.Text.Encoding.UTF8.GetBytes(csv.ToString());
            var base64 = Convert.ToBase64String(bytes);

            await JS.InvokeVoidAsync("downloadFile", "MigrationResults.csv", "text/csv", base64);

            Logger.LogInformation("CSV results downloaded");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error downloading CSV: {ex.Message}";
            Logger.LogError(ex, "Error downloading CSV results");
        }
    }

    private async Task DownloadResultsExcel()
    {
        try
        {
            using var workbook = new XLWorkbook();
            var worksheet = workbook.Worksheets.Add("Migration Results");

            worksheet.Cell(1, 1).Value = "Email";
            worksheet.Cell(1, 2).Value = "FirstName";
            worksheet.Cell(1, 3).Value = "LastName";
            worksheet.Cell(1, 4).Value = "DisplayName";
            worksheet.Cell(1, 5).Value = "Status";
            worksheet.Cell(1, 6).Value = "B2CObjectId";
            worksheet.Cell(1, 7).Value = "ErrorMessage";

            var headerRange = worksheet.Range(1, 1, 1, 7);
            headerRange.Style.Font.Bold = true;
            headerRange.Style.Fill.BackgroundColor = XLColor.LightBlue;

            int row = 2;
            foreach (var result in migrationResults)
            {
                var status = result.Revoked ? "Revoked" : (result.Success ? "Active" : "Failed");
                
                worksheet.Cell(row, 1).Value = result.Email;
                worksheet.Cell(row, 2).Value = result.FirstName;
                worksheet.Cell(row, 3).Value = result.LastName;
                worksheet.Cell(row, 4).Value = result.DisplayName;
                worksheet.Cell(row, 5).Value = status;
                worksheet.Cell(row, 6).Value = result.B2CObjectId;
                worksheet.Cell(row, 7).Value = result.ErrorMessage;

                if (result.Revoked)
                {
                    worksheet.Row(row).Style.Fill.BackgroundColor = XLColor.LightYellow;
                }
                else if (result.Success)
                {
                    worksheet.Row(row).Style.Fill.BackgroundColor = XLColor.LightGreen;
                }
                else
                {
                    worksheet.Row(row).Style.Fill.BackgroundColor = XLColor.LightPink;
                }

                row++;
            }

            worksheet.Columns().AdjustToContents();

            using var stream = new MemoryStream();
            workbook.SaveAs(stream);
            var content = stream.ToArray();
            var base64 = Convert.ToBase64String(content);

            await JS.InvokeVoidAsync("downloadFile", "MigrationResults.xlsx", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", base64);

            Logger.LogInformation("Excel results downloaded");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error downloading Excel: {ex.Message}";
            Logger.LogError(ex, "Error downloading Excel results");
        }
    }

    private async Task RevokeMigration()
    {
        var successfulMigrations = migrationResults
            .Where(r => r.Success && !r.Revoked && !string.IsNullOrEmpty(r.B2CObjectId))
            .Select(r => r.B2CObjectId!)
            .ToList();

        if (successfulMigrations.Count == 0)
        {
            errorMessage = "No users to revoke.";
            return;
        }

        isRevoking = true;
        revokeResults.Clear();
        errorMessage = string.Empty;
        StateHasChanged();

        try
        {
            Logger.LogInformation("Starting revoke of {Count} users", successfulMigrations.Count);

            var response = await MigrationService.RevokeUsersAsync(successfulMigrations);

            if (response != null && response.Results != null)
            {
                revokeResults = response.Results;

                // Update migration results to reflect revoked users
                foreach (var revokeResult in revokeResults.Where(r => r.Success))
                {
                    var migrationResult = migrationResults.FirstOrDefault(m => m.B2CObjectId == revokeResult.B2CObjectId);
                    if (migrationResult != null)
                    {
                        migrationResult.Revoked = true;
                        migrationResult.ErrorMessage = "User deleted from B2C";
                    }
                }

                var revokedCount = revokeResults.Count(r => r.Success);
                var failedCount = revokeResults.Count(r => !r.Success);

                Logger.LogInformation("Revoke completed. Revoked: {Revoked}, Failed: {Failed}", revokedCount, failedCount);

                if (failedCount > 0)
                {
                    errorMessage = $"Revoke partially completed. {revokedCount} revoked, {failedCount} failed.";
                }
            }
            else
            {
                errorMessage = "No response received from revoke service.";
                Logger.LogWarning("Revoke service returned null response");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Revoke error: {ex.Message}";
            Logger.LogError(ex, "Error during user revoke");
        }
        finally
        {
            isRevoking = false;
            StateHasChanged();
        }
    }
}
